<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Google_Photos_icon_%282020%29.svg/1024px-Google_Photos_icon_%282020%29.svg.png" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* === Переменные Цветов === */
        :root {
            --color-text-light: #444746;
            --color-text-dark: #C4C7C5;
            --color-background-light: #F0F4F9;
            --color-background-dark: #1E1F20;
            --color-surface-light: #d8dadb;
            --color-surface-dark: #3c4043;
            --color-card-background-light: #ffffff;
            --color-card-background-dark: #292a2e;
            --color-divider-light: #C4C7C5;
            --color-divider-dark: #444746;
            --color-link-active-light: #004A77;
            --color-link-active-dark: #C2E7FF;
            --color-link-active-highlight-light: #C2E7FF;
            --color-link-active-highlight-dark: #004A77;
            --color-badge-light: #004A77;
            --color-badge-dark: #C2E7FF;
            --color-shadow-light: rgba(60, 64, 67, 0.15);
            --color-shadow-dark: rgba(0, 0, 0, 0.5);
            
            /* Цвета скроллбара */
            --color-scrollbar-thumb-light: rgba(60, 64, 67, 0.4);
            --color-scrollbar-thumb-hover-light: rgba(60, 64, 67, 0.6);
            --color-scrollbar-thumb-dark: rgba(196, 199, 197, 0.4);
            --color-scrollbar-thumb-hover-dark: rgba(196, 199, 197, 0.6);

            --font-size-small: 14px;
            --header-item-spacing: 8px;
            --header-element-height: 36px;
            --search-width-desktop: 180px; 
            --search-width-mobile: 130px; 
        }

        /* --- Темы --- */
        body.dark-theme {
            --color-text: var(--color-text-dark);
            --color-text-on-surface: #e8eaed;
            --color-background: var(--color-background-dark);
            --color-surface: var(--color-surface-dark);
            --color-card-background: var(--color-card-background-dark);
            --color-divider: var(--color-divider-dark);
            --color-shadow: var(--color-shadow-dark);
            --color-link-active: var(--color-link-active-dark);
            --color-link-active-highlight: var(--color-link-active-highlight-dark);
            --color-badge: var(--color-badge-dark);
            --color-scrollbar: var(--color-scrollbar-thumb-dark);
            --color-scrollbar-hover: var(--color-scrollbar-thumb-hover-dark);
        }

        body { /* Светлая тема по умолчанию */
            --color-text: var(--color-text-light);
            --color-text-on-surface: #202124;
            --color-background: var(--color-background-light);
            --color-surface: var(--color-surface-light);
            --color-card-background: var(--color-card-background-light);
            --color-divider: var(--color-divider-light);
            --color-shadow: var(--color-shadow-light);
            --color-link-active: var(--color-link-active-light);
            --color-link-active-highlight: var(--color-link-active-highlight-light);
            --color-badge: var(--color-badge-light);
            --color-scrollbar: var(--color-scrollbar-thumb-light);
            --color-scrollbar-hover: var(--color-scrollbar-thumb-hover-light);
        }

        /* === Общие Стили === */
        * { box-sizing: border-box; }
        
        /* Основные стили страницы и шрифты */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-on-surface);
            transition: background-color 0.3s, color 0.3s;
        }
        
        a { text-decoration: none; color: inherit; }

        /* === Шапка === */
        .header {
            position: fixed; top: 0; left: 0; width: 100%; height: 64px;
            display: flex; align-items: center; padding: 0 24px;
            background-color: var(--color-background);
            border-bottom: 1px solid var(--color-divider);
            box-shadow: 0 2px 4px var(--color-shadow);
            z-index: 1000;
            transition: background-color 0.3s, border-color 0.3s;
            user-select: none; 
            -webkit-user-select: none;
        }
        
        .logo-link { display: flex; align-items: center; margin-right: 32px; flex-shrink: 0; overflow: hidden; }
        .logo { width: 32px; height: 32px; margin-right: 8px; }
        .logo-text {
            font-size: 20px; font-weight: 500; color: var(--color-text);
            transform: translateY(-2px); white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; display: block; width: 132px;
            text-align: center;
        }

        /* --- Фильтры Годов --- */
        .filters { 
            display: flex; 
            flex-grow: 1; 
            margin-right: 0; 
            overflow: hidden; 
            flex-shrink: 1; 
            justify-content: start;
        }
        
        .filter-link {
            width: 56px; margin-right: 8px; padding: 0;
            display: inline-flex; justify-content: center; align-items: center;
            height: 32px; border-radius: 16px;
            font-size: var(--font-size-small); font-weight: 500;
            color: var(--color-text);
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer; user-select: none; flex-shrink: 0;
        }
        .filter-link:hover { background-color: var(--color-surface); }
        .filter-link.active { color: var(--color-link-active); background-color: var(--color-link-active-highlight); }
        
        /* --- Меню и Дропдауны --- */
        .menu-content, .sort-content {
            display: none; position: absolute; top: 48px;
            background-color: var(--color-card-background);
            box-shadow: 0 4px 8px var(--color-shadow);
            border-radius: 8px; width: 64px; z-index: 100; padding: 0; 
        }
        .menu-content.show, .sort-content.show { display: block; }

        /* Общие стили для скроллбаров в меню */
        .menu-content, .sort-content, .search-suggestions {
            max-height: 340px; overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent; 
            transition: scrollbar-color 0.3s;
        }
        .menu-content:hover, .sort-content:hover, .search-suggestions:hover {
            scrollbar-color: var(--color-scrollbar) transparent;
        }
        .menu-content::-webkit-scrollbar, .sort-content::-webkit-scrollbar, .search-suggestions::-webkit-scrollbar {
            width: 12px; background-color: transparent;
        }
        .menu-content::-webkit-scrollbar-track, .sort-content::-webkit-scrollbar-track, .search-suggestions::-webkit-scrollbar-track {
            background-color: transparent;
        }
        .menu-content::-webkit-scrollbar-thumb, .sort-content::-webkit-scrollbar-thumb, .search-suggestions::-webkit-scrollbar-thumb {
            background-color: transparent; border-radius: 6px; border: 3px solid transparent; background-clip: content-box; transition: background-color 0.3s;
        }
        .menu-content:hover::-webkit-scrollbar-thumb, .sort-content:hover::-webkit-scrollbar-thumb, .search-suggestions:hover::-webkit-scrollbar-thumb {
            background-color: var(--color-scrollbar);
        }
        .menu-content::-webkit-scrollbar-thumb:hover, .sort-content::-webkit-scrollbar-thumb:hover, .search-suggestions::-webkit-scrollbar-thumb:hover {
            background-color: var(--color-scrollbar-hover);
        }
        
        .sort-content {
            left: 50%; transform: translateX(-50%);
            width: 200px;
        }

        .menu-content-item, .sort-content-item {
            display: block; padding: 10px 8px;
            font-size: var(--font-size-small); font-weight: 500;
            color: var(--color-text); cursor: pointer; white-space: nowrap;
        }
        .menu-content-item:hover, .sort-content-item:hover { background-color: var(--color-surface); }
        .menu-content-item.active, .sort-content-item.active {
            color: var(--color-link-active); font-weight: 500;
            background-color: var(--color-link-active-highlight);
        }
        
        .menu-dropdown { position: relative; display: none; margin-right: var(--header-item-spacing); flex-shrink: 0; }
        .menu-button {
            width: 40px; height: 40px; padding: 0;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; cursor: pointer; transition: background-color 0.2s; color: var(--color-text); 
        }
        .menu-button:hover { background-color: var(--color-surface); }

        /* --- Сортировка --- */
        .sort-dropdown { margin-right: 12px; position: relative; flex-shrink: 0; }
        .sort-button {
            display: flex; align-items: center; padding: 0 12px 0 8px;
            height: var(--header-element-height); width: 200px;
            border-radius: 18px; background-color: var(--color-surface);
            font-size: var(--font-size-small); font-weight: 500;
            cursor: pointer; user-select: none; color: var(--color-text);
            transition: background-color 0.2s, width 0.3s, padding 0.3s;
        }
        .sort-button:hover { filter: brightness(0.9); }
        .sort-button-icon { margin-right: 8px; font-size: 20px; color: var(--color-text); }
        .sort-button-text { transition: opacity 0.3s; }
        
        .sort-content-item { display: flex; align-items: center; }
        .sort-content-item .material-icons { margin-right: 12px; font-size: 20px; color: var(--color-text); }
        .sort-content-item span[data-sort-label] { margin-right: 8px; }

        /* --- Поиск --- */
        .search-container {
            margin-right: var(--header-item-spacing); position: relative;
            flex-grow: 0; width: 180px; transition: width 0.3s; flex-shrink: 0;
        }
        .search-input {
            padding: 0 36px 0 40px; border: none; border-radius: 20px;
            background-color: var(--color-surface); color: var(--color-text);
            font-size: var(--font-size-small); width: 100%; outline: none;
            transition: background-color 0.3s; height: var(--header-element-height); 
            user-select: text; 
            -webkit-user-select: text;
        }
        .search-input:hover, .search-input:focus { background-color: var(--color-card-background); }
        .search-icon {
            position: absolute; left: 8px; top: 50%; transform: translateY(-50%);
            color: var(--color-text); pointer-events: none; opacity: 1; z-index: 10;
        }
        .clear-button {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            color: var(--color-text); cursor: pointer; padding: 4px;
            border-radius: 50%; font-size: 20px; display: none;
        }
        .clear-button:hover { background-color: var(--color-background); }

        /* --- Меню предложений поиска --- */
        .search-suggestions {
            display: none;
            position: absolute;
            top: 48px; 
            left: 0;
            width: 100%; 
            background-color: var(--color-card-background);
            box-shadow: 0 4px 8px var(--color-shadow);
            border-radius: 8px;
            z-index: 100;
            padding: 0;
            max-height: 340px;
            overflow-y: auto;
        }
        .search-suggestions.show { display: block; }

        .search-suggestion-item {
            display: block; padding: 10px 12px;
            font-size: var(--font-size-small); font-weight: 500;
            color: var(--color-text); cursor: pointer; white-space: nowrap;
        }
        .search-suggestion-item:hover { background-color: var(--color-surface); }

        /* --- Кнопка Темы и Профиль --- */
        .theme-button {
            margin-right: var(--header-item-spacing); width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; cursor: pointer; color: var(--color-text); flex-shrink: 0;
        }
        .theme-button:hover { background-color: var(--color-surface); }
        
        .profile-logo {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            cursor: pointer; border: 2px solid var(--color-surface); flex-shrink: 0;
        }

        /* === Карточки и Сетка (Главный контейнер) === */
        .album-grid {
            position: absolute;
            top: 64px; 
            bottom: 0; 
            left: 0;
            right: 0;
            overflow-y: scroll; 
            padding: 24px 12px 24px 24px; 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 24px;
            align-content: flex-start; 
            grid-auto-rows: max-content; 
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent; 
            transition: scrollbar-color 0.3s;
        }

        /* Логика отображения скроллбара при прокрутке */
        .album-grid.is-scrolling { scrollbar-color: var(--color-scrollbar) transparent; }

        .album-grid::-webkit-scrollbar { width: 12px; background-color: transparent; }
        .album-grid::-webkit-scrollbar-track { background-color: transparent; }
        .album-grid::-webkit-scrollbar-thumb {
            background-color: transparent; 
            border-radius: 6px;
            border: 3px solid transparent;
            background-clip: content-box;
            transition: background-color 0.3s;
        }
        
        .album-grid.is-scrolling::-webkit-scrollbar-thumb,
        .album-grid::-webkit-scrollbar-thumb:hover { background-color: var(--color-scrollbar); }
        .album-grid::-webkit-scrollbar-thumb:hover { background-color: var(--color-scrollbar-hover); }

        .album-card {
            background-color: var(--color-card-background); border-radius: 8px;
            overflow: hidden; box-shadow: 0 1px 3px var(--color-shadow);
            transition: box-shadow 0.3s, transform 0.3s;
            height: fit-content; 
        }
        .album-card:hover {
            box-shadow: 0 4px 8px var(--color-shadow); transform: translateY(-2px);
        }
        .album-card-link { display: block; }
        .album-preview {
            width: 100%; padding-top: 56.25%; position: relative;
            background-size: cover; background-position: center;
        }
        .new-badge {
            position: absolute; top: 8px; right: 8px; width: 30px; height: 30px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background-color: var(--color-card-background); box-shadow: 0 1px 3px var(--color-shadow);
            z-index: 10;
        }
        .new-badge .material-icons { font-size: 20px; color: var(--color-link-active); }
        
        .album-info {
            padding: 4px 12px; display: flex; flex-direction: column;
            justify-content: center; min-height: 48px; 
        }
        .album-title {
            font-size: var(--font-size-small); font-weight: 500; line-height: 1.4;
            color: var(--color-text); display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden; max-height: calc(1.4em * 2); 
        }

        /* === Адаптивные Стили === */
        @media (max-width: 750px) {
            .header { padding: 0 10px; }
            .logo-text { display: none; }
            .logo-link { margin-right: 0; }
            
            .sort-dropdown { margin-right: var(--header-item-spacing); }
            .sort-button { width: var(--header-element-height); padding: 0 8px; justify-content: center; }
            .sort-button-icon { margin-right: 0; }
            .sort-button-text { display: none; }
            .sort-content { left: 50%; transform: translateX(-50%); }

            .search-container { width: var(--search-width-mobile); }
            .filters { flex-grow: 0; }
            
            .album-grid { padding-right: 24px; }
        }
    </style>
</head>
<body class="light-theme">

    <header class="header" id="main-header">
        <a href="https://photos.google.com/" class="logo-link" target="_self">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Google_Photos_icon_%282020%29.svg/1024px-Google_Photos_icon_%282020%29.svg.png" alt="Google Photos Logo" class="logo">
            <span class="logo-text" id="logo-text"></span>
        </a>

        <div class="filters" id="year-filters"></div>
        
        <div class="menu-dropdown">
            <span class="material-icons menu-button" id="menu-button">menu</span>
            <div class="menu-content" id="menu-content"></div>
        </div>

        <div class="sort-dropdown">
            <div class="sort-button" id="sort-button">
                <span class="material-icons sort-button-icon" id="sort-icon">arrow_downward</span>
                <span id="sort-label" class="sort-button-text"></span>
            </div>
            <div class="sort-content" id="sort-content">
                <div class="sort-content-item" data-sort="newest"><span class="material-icons">arrow_downward</span><span data-sort-label="newest"></span></div>
                <div class="sort-content-item" data-sort="oldest"><span class="material-icons">arrow_upward</span><span data-sort-label="oldest"></span></div>
                <div class="sort-content-item" data-sort="added"><span class="material-icons">notifications</span><span data-sort-label="added"></span></div>
            </div>
        </div>

        <div class="search-container" id="search-container">
            <span class="material-icons search-icon" id="search-icon-small">search</span>
            <input type="text" id="search-input" class="search-input" placeholder="">
            <span class="material-icons clear-button" id="clear-search-button">close</span>
            <div class="search-suggestions" id="search-suggestions"></div>
        </div>

        <span class="material-icons theme-button" id="theme-toggle">nightlight_round</span>

        <img src="https://lh3.googleusercontent.com/a/ACg8ocLU5rbDdy25qbia4Zv6ltz5hHFRWhP79PncRQ9CQ-cdm9nYRfxxmw=s96-c" alt="Profile Logo" class="profile-logo" title="2025(с) Alex Kravtsov & Gemini">
    </header>

    <main class="album-grid" id="album-grid"></main>

    <script src="albums.js"></script>

    <script>
        // --- ЛОКАЛИЗАЦИЯ (ПЕРЕВОДЫ) ---
        const TRANSLATIONS = {
            'title': { ru: 'Мои альбомы Google Фото', uk: 'Мої альбоми Google Фото', en: 'My Google Photos albums' },
            'logo_text': { ru: 'Google Фото', uk: 'Google Фото', en: 'Google Photos' },
            'all_filter': { ru: 'Все', uk: 'Всі', en: 'All' },
            'newest_sort': { ru: 'Самые новые', uk: 'Найновіші', en: 'Newest' },
            'oldest_sort': { ru: 'Самые старые', uk: 'Найстаріші', en: 'Oldest' },
            'added_sort': { ru: 'Недавно добавленные', uk: 'Нещодавно додані', en: 'Rescently added' },
            'search_placeholder': { ru: 'Поиск...', uk: 'Пошук...', en: 'Search...' },
            'not_found': { ru: 'Не найдено...', uk: 'Не знайдено...', en: 'Not found...' }
        };

        // --- ДАННЫЕ ДЛЯ МЕНЮ ПРЕДЛОЖЕНИЙ ПОИСКА ---
        const SEARCH_SUGGESTIONS_DATA = [
            { ru: 'арсен', uk: 'арсен', en: 'arsenii' },
            { ru: 'матве', uk: 'матві', en: 'matviy' },
            { ru: 'день рождения', uk: 'день народження', en: 'birthday' },
            { ru: 'день', uk: 'день', en: 'day' },
            { ru: 'праздник', uk: 'свято', en: 'holiday' },
            { ru: 'фестиваль', uk: 'фестиваль', en: 'festival' },
            { ru: 'кемпинг', uk: 'кемпінг', en: 'camping' },
            { ru: 'авто', uk: 'авто', en: 'car' },
            { ru: 'парк', uk: 'парк', en: 'park' },
            { ru: 'концерт', uk: 'концерт', en: 'concert' },
            { ru: 'музей', uk: 'музей', en: 'museum' }
        ];

        // Определяет язык пользователя и загружает соответствующие строки локализации
        function getLocaleStrings() {
            const userLang = (navigator.language || navigator.userLanguage).toLowerCase();
            let lang = 'en'; 

            if (userLang.startsWith('ru')) {
                lang = 'ru';
            } else if (userLang.startsWith('uk')) {
                lang = 'uk';
            }

            const strings = { lang: lang }; 
            for (const key in TRANSLATIONS) {
                strings[key] = TRANSLATIONS[key][lang] || TRANSLATIONS[key]['en'];
            }
            
            document.documentElement.lang = lang;
            return strings;
        }

        const STRINGS = getLocaleStrings();

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ и СОСТОЯНИЕ ---

        const STORAGE_KEYS = {
            THEME: 'album_theme',
            YEAR: 'album_year',
            SORT: 'album_sort',
            SEARCH: 'album_search'
        };

        const UI = {
            grid: document.getElementById('album-grid'),
            logoText: document.getElementById('logo-text'),
            filtersContainer: document.getElementById('year-filters'),
            menuButton: document.getElementById('menu-button'),
            menuContent: document.getElementById('menu-content'),
            menuDropdown: document.querySelector('.menu-dropdown'),
            sortButton: document.getElementById('sort-button'),
            sortContent: document.getElementById('sort-content'),
            sortIcon: document.getElementById('sort-icon'),
            sortLabel: document.getElementById('sort-label'),
            searchInput: document.getElementById('search-input'),
            clearButton: document.getElementById('clear-search-button'),
            searchSuggestions: document.getElementById('search-suggestions'),
            themeToggle: document.getElementById('theme-toggle'),
            header: document.getElementById('main-header'),
        };

        const state = {
            year: 'all',
            sort: localStorage.getItem(STORAGE_KEYS.SORT) || 'newest', 
            search: ''
        };
        
        // --- ЛОГИКА МЕНЮ ---
        
        /** Закрывает все выпадающие меню, кроме указанного (или всех, если не указано) */
        function closeAllMenus(excludeElement = null) {
            const menus = [UI.menuContent, UI.sortContent, UI.searchSuggestions];
            menus.forEach(menu => {
                if (menu && menu !== excludeElement) {
                    menu.classList.remove('show');
                }
            });
        }

        /** Переключает состояние меню (открыть/закрыть), закрывая при этом все остальные. */
        function toggleMenu(menuElement, e) {
            e.stopPropagation();
            const isShowing = menuElement.classList.contains('show');
            
            // 1. Закрыть все остальные меню, кроме текущего
            closeAllMenus(menuElement);
            
            // 2. Свернуть/развернуть текущее меню
            if (isShowing) {
                menuElement.classList.remove('show');
            } else {
                menuElement.classList.add('show');
            }
        }
        
        /** Принудительно открывает меню, закрывая все остальные. Используется, например, после очистки поиска. */
        function openMenu(menuElement, e) {
            e.stopPropagation();
            closeAllMenus(menuElement);
            menuElement.classList.add('show');
        }
        
        // --- РЕНДЕРИНГ И СОРТИРОВКА ---
        
        /** Проверяет, был ли альбом добавлен в течение последней недели. */
        function isRecentlyAdded(addedDateStr) {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const addedDate = new Date(addedDateStr);
            return addedDate > oneWeekAgo;
        }

        /** Создает HTML-карточку альбома. */
        function createAlbumCard(album) {
            const card = document.createElement('div');
            card.className = 'album-card';
            const badgeHTML = isRecentlyAdded(album.addedDate) ? '<div class="new-badge"><span class="material-icons">notifications</span></div>' : '';
            
            const currentLang = STRINGS.lang;
            const fullTitle = album.title[currentLang] || album.title['ru']; 

            card.innerHTML = `
                <a href="${album.url}" class="album-card-link" target="_self">
                    <div class="album-preview" style="background-image: url('${album.previewUrl}')">
                        ${badgeHTML}
                    </div>
                    <div class="album-info">
                        <div class="album-title"></div>
                    </div>
                </a>
            `;
            card.querySelector('.album-title').textContent = fullTitle; 
            return card;
        }

        /** Применяет текущую сортировку к массиву альбомов. */
        function getSortedAlbums() {
            let sorted = [...albums];
            
            switch (state.sort) {
                case 'newest':
                    // Сортировка от новых альбомов к старым (по дате альбома)
                    sorted.sort((a, b) => b.date.localeCompare(a.date));
                    break;
                case 'oldest':
                    sorted.sort((a, b) => a.date.localeCompare(b.date));
                    break;
                case 'added':
                    // Сортировка по дате добавления
                    sorted.sort((a, b) => b.addedDate.localeCompare(a.addedDate));
                    break;
            }
            return sorted;
        }

        /** Фильтрует и отрисовывает альбомы в сетке. */
        function renderAlbums() {
            UI.grid.innerHTML = '';
            let result = getSortedAlbums();

            // Фильтрация по году
            if (state.year !== 'all') {
                result = result.filter(a => a.year === state.year);
            }

            // Фильтрация по поисковому запросу
            if (state.search) {
                const query = state.search.toLowerCase();
                const currentLang = STRINGS.lang;

                result = result.filter(a => {
                    const fullTitle = (a.title[currentLang] || a.title['ru']).toLowerCase();
                    return fullTitle.includes(query);
                });
            }

            if (result.length > 0) {
                result.forEach(album => UI.grid.appendChild(createAlbumCard(album)));
            } else {
                UI.grid.innerHTML = `<p style="text-align: center; width: 100%; color: var(--color-text); padding: 20px;">${STRINGS.not_found}</p>`;
            }

            updateActiveClasses();
        }

        /** Обновляет активные классы для фильтров и сортировки. */
        function updateActiveClasses() {
            document.querySelectorAll('.filter-link, .menu-content-item').forEach(el => {
                el.classList.toggle('active', el.getAttribute('data-year') === state.year);
            });
            document.querySelectorAll('.sort-content-item').forEach(el => {
                el.classList.toggle('active', el.getAttribute('data-sort') === state.sort);
            });
        }

        /** Обновляет иконку и текст на кнопке сортировки. */
        function updateSortButtonUI() {
            const map = {
                newest: { icon: 'arrow_downward', label: STRINGS.newest_sort },
                oldest: { icon: 'arrow_upward', label: STRINGS.oldest_sort },
                added: { icon: 'notifications', label: STRINGS.added_sort }
            };
            const current = map[state.sort] || map.newest;
            UI.sortIcon.textContent = current.icon;
            UI.sortLabel.textContent = current.label;
        }

        /** Функция задержки (debounce) для обработки ввода. */
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        /** Обработчик ввода в поле поиска с задержкой. */
        const handleSearchInput = debounce((e) => {
            state.search = e.target.value.trim();
            localStorage.setItem(STORAGE_KEYS.SEARCH, state.search);
            UI.clearButton.style.display = state.search ? 'block' : 'none';
            renderAlbums();
        }, 300);

        // --- ЛОГИКА МЕНЮ ПРЕДЛОЖЕНИЙ ПОИСКА ---
        function initSearchSuggestions() {
            UI.searchSuggestions.innerHTML = '';
            const currentLang = STRINGS.lang;

            // Генерация элементов предложений из данных
            SEARCH_SUGGESTIONS_DATA.forEach(item => {
                const text = item[currentLang] || item['en'];
                const div = document.createElement('div');
                div.className = 'search-suggestion-item';
                div.textContent = text;
                
                // При клике на предложение - заполняем поле, ищем и закрываем меню
                div.onmousedown = (e) => {
                    e.preventDefault(); 
                    UI.searchInput.value = text;
                    state.search = text.trim();
                    localStorage.setItem(STORAGE_KEYS.SEARCH, state.search);
                    UI.clearButton.style.display = 'block';
                    renderAlbums();
                    
                    UI.searchSuggestions.classList.remove('show');
                };
                UI.searchSuggestions.appendChild(div);
            });
            
            // ИЗМЕНЕНИЕ: Клик мышью (десктоп) - переключает (открывает/закрывает) меню
            UI.searchInput.addEventListener('click', (e) => {
                toggleMenu(UI.searchSuggestions, e);
            });
            
            // ИЗМЕНЕНИЕ: Тап (мобильный) - только открывает меню
            UI.searchInput.addEventListener('touchstart', (e) => {
                // Если меню уже открыто, то touchstart не должен ничего делать, чтобы тап не закрыл его
                if (!UI.searchSuggestions.classList.contains('show')) {
                    openMenu(UI.searchSuggestions, e); 
                }
            }, { passive: true });
            
            // Предотвращение закрытия меню при взаимодействии внутри него
            ['click', 'touchstart', 'touchmove'].forEach(evt => {
                UI.searchSuggestions.addEventListener(evt, (e) => {
                    e.stopPropagation(); 
                }, { passive: true });
            });
        }

        // --- Инициализация Фильтров Годов ---
        function initYearFilters() {
            const years = [...new Set(albums.map(a => a.year))].sort((a, b) => b - a);

            const createLink = (text, year, isMenuItem) => {
                const el = document.createElement(isMenuItem ? 'div' : 'a');
                el.className = isMenuItem ? 'menu-content-item' : 'filter-link';
                el.setAttribute('data-year', year);
                el.textContent = text;
                el.onclick = (e) => {
                    e.stopPropagation();
                    state.year = year;
                    localStorage.setItem(STORAGE_KEYS.YEAR, year);
                    renderAlbums();
                    // Закрываем все меню при выборе фильтра
                    closeAllMenus();
                };
                return el;
            };

            // Создание основных кнопок фильтров
            UI.filtersContainer.appendChild(createLink(STRINGS.all_filter, 'all', false));
            years.forEach(y => UI.filtersContainer.appendChild(createLink(y, y, false)));

            // Логика адаптивного скрытия/показа фильтров в дополнительном меню
            function updateFiltersVisibility() {
                UI.menuDropdown.style.display = 'none';
                const allElements = Array.from(UI.filtersContainer.children);
                allElements.forEach(el => el.style.display = 'inline-flex');

                const containerWidth = UI.filtersContainer.offsetWidth;
                const itemWidth = 64; 
                const menuBtnWidth = 48; 
                const totalNeeded = allElements.length * itemWidth;

                UI.menuContent.innerHTML = '';

                if (totalNeeded <= containerWidth) {
                    return;
                }

                const usableWidth = containerWidth - menuBtnWidth;
                let usedWidth = 0;
                let hasHidden = false;

                allElements.forEach(el => {
                    if (usedWidth + itemWidth <= usableWidth) {
                        el.style.display = 'inline-flex';
                        usedWidth += itemWidth;
                    } else {
                        el.style.display = 'none';
                        hasHidden = true;
                        UI.menuContent.appendChild(createLink(el.textContent, el.getAttribute('data-year'), true));
                    }
                });

                if (hasHidden) {
                    UI.menuDropdown.style.display = 'block';
                }
            }

            const debouncedResize = debounce(updateFiltersVisibility, 25);
            window.addEventListener('resize', debouncedResize);
            window.addEventListener('orientationchange', () => setTimeout(updateFiltersVisibility, 300));

            requestAnimationFrame(updateFiltersVisibility);
        }

        // --- ЛОГИКА СОРТИРОВКИ И СКРОЛЛБАРА ---
        function initScrollLogic() {
            let scrollTimeout;
            const scrollContainer = UI.grid;

            // Показывает скроллбар на короткое время
            const showScroll = () => {
                scrollContainer.classList.add('is-scrolling');
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    scrollContainer.classList.remove('is-scrolling');
                }, 1500);
            };

            // Показываем скроллбар при наведении на край экрана (имитация)
            document.addEventListener('mousemove', (e) => {
                if (window.innerWidth - e.clientX < 20) {
                    showScroll();
                }
            });

            // Показываем скроллбар при скролле
            scrollContainer.addEventListener('scroll', () => {
                showScroll();
            });
            
            // --- ИЗМЕНЕНИЕ 1: Обработка прокрутки колесом мыши над шапкой (теперь без проверки открытых меню)
            UI.header.addEventListener('wheel', (e) => {
                // Прокрутка главного контейнера альбомов с использованием инерции
                scrollContainer.scrollTop += e.deltaY * 5;
                showScroll();
                // Предотвращаем прокрутку родительского элемента (окна), что обеспечивает системную инерцию
                e.preventDefault(); 
            }, { passive: false }); // passive: false для e.preventDefault()
            
            // --- ИЗМЕНЕНИЕ 2: Блокировка прокрутки альбомов при прокрутке меню
            [UI.menuContent, UI.sortContent, UI.searchSuggestions].forEach(menu => {
                if (menu) {
                    menu.addEventListener('wheel', (e) => {
                        // Останавливаем всплытие, чтобы событие wheel не дошло до UI.header или window
                        e.stopPropagation();
                    }, { passive: true });
                }
            });

            // Обработка прокрутки с клавиатуры
            window.addEventListener('keydown', (e) => {
                if (document.activeElement === UI.searchInput) return;

                const scrollAmount = 50; 
                const pageAmount = scrollContainer.clientHeight * 0.9; 
                let handled = false;

                switch (e.key) {
                    case 'ArrowDown':
                        scrollContainer.scrollTop += scrollAmount;
                        handled = true;
                        break;
                    case 'ArrowUp':
                        scrollContainer.scrollTop -= scrollAmount;
                        handled = true;
                        break;
                    case 'PageDown':
                        scrollContainer.scrollTop += pageAmount;
                        handled = true;
                        break;
                    case 'PageUp':
                        scrollContainer.scrollTop -= pageAmount;
                        handled = true;
                        break;
                    case 'Home':
                        scrollContainer.scrollTop = 0;
                        handled = true;
                        break;
                    case 'End':
                        scrollContainer.scrollTop = scrollContainer.scrollHeight;
                        handled = true;
                        break;
                    case ' ': 
                        if (e.shiftKey) {
                            scrollContainer.scrollTop -= pageAmount;
                        } else {
                            scrollContainer.scrollTop += pageAmount;
                        }
                        handled = true;
                        break;
                }

                if (handled) {
                    e.preventDefault(); 
                    showScroll(); 
                }
            });
        }

        // --- ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ ---
        document.addEventListener('DOMContentLoaded', () => {
            // Применение локализации
            document.title = STRINGS.title;
            UI.logoText.textContent = STRINGS.logo_text;
            UI.searchInput.placeholder = STRINGS.search_placeholder;
            
            document.querySelector('.sort-content-item[data-sort="newest"]').querySelector('span[data-sort-label]').textContent = STRINGS.newest_sort;
            document.querySelector('.sort-content-item[data-sort="oldest"]').querySelector('span[data-sort-label]').textContent = STRINGS.oldest_sort;
            document.querySelector('.sort-content-item[data-sort="added"]').querySelector('span[data-sort-label]').textContent = STRINGS.added_sort;

            // Восстановление состояния из localStorage
            state.year = localStorage.getItem(STORAGE_KEYS.YEAR) || 'all';
            state.sort = localStorage.getItem(STORAGE_KEYS.SORT) || 'newest';
            state.search = localStorage.getItem(STORAGE_KEYS.SEARCH) || '';

            UI.searchInput.value = state.search;
            if(state.search) UI.clearButton.style.display = 'block';
            updateSortButtonUI();
            
            // Обработчик ввода текста: скрывает меню предложений сразу при начале ввода
            UI.searchInput.addEventListener('input', (e) => {
                UI.searchSuggestions.classList.remove('show');
                handleSearchInput(e);
            });

            // Обработчик кнопки очистки поиска
            UI.clearButton.addEventListener('click', (e) => {
                UI.searchInput.value = '';
                handleSearchInput({ target: UI.searchInput });
                
                // Открываем меню предложений и устанавливаем фокус
                openMenu(UI.searchSuggestions, e); 
                UI.searchInput.focus(); 
            });

            // Обработчик кнопки сортировки
            UI.sortButton.addEventListener('click', (e) => {
                toggleMenu(UI.sortContent, e);
            });

            // Обработчики пунктов меню сортировки
            document.querySelectorAll('.sort-content-item').forEach(item => {
                item.onclick = (e) => {
                    e.stopPropagation();
                    const newSort = item.getAttribute('data-sort');
                    state.sort = newSort;
                    localStorage.setItem(STORAGE_KEYS.SORT, newSort);
                    updateSortButtonUI();
                    renderAlbums();
                    UI.sortContent.classList.remove('show');
                };
            });

            // Обработчик кнопки дополнительного меню фильтров
            UI.menuButton.onclick = (e) => {
                toggleMenu(UI.menuContent, e);
            };

            // Инициализация всех компонентов
            initYearFilters();
            renderAlbums();
            initScrollLogic();
            initSearchSuggestions();

            // --- ТЕМНАЯ / СВЕТЛАЯ ТЕМА ---
            const applyTheme = (isDark) => {
                document.body.classList.toggle('dark-theme', isDark);
                UI.themeToggle.textContent = isDark ? 'light_mode' : 'nightlight_round';
            };

            const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME);
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

            if (savedTheme) {
                applyTheme(savedTheme === 'dark');
            } else {
                applyTheme(mediaQuery.matches);
            }

            mediaQuery.addEventListener('change', (e) => {
                if (!localStorage.getItem(STORAGE_KEYS.THEME)) {
                    applyTheme(e.matches);
                }
            });

            // Переключение темы при клике
            UI.themeToggle.onclick = () => {
                const isCurrentDark = document.body.classList.contains('dark-theme');
                const newThemeIsDark = !isCurrentDark;
                applyTheme(newThemeIsDark);
                localStorage.setItem(STORAGE_KEYS.THEME, newThemeIsDark ? 'dark' : 'light');
            };

            // Закрытие всех меню при клике в любом месте страницы
            window.addEventListener('click', () => {
                closeAllMenus();
            });
        });
    </script>
</body>
</html>
